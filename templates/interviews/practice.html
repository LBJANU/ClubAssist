{% extends 'main/base.html' %}

{% block title %}Practice: {{ question.title }}{% endblock %}

{% block content %}
<!-- Enhanced Audio Preference Notice - Full Width -->
<div class="max-w-7xl mx-auto px-4 py-6">
    <div class="glass border-l-4 border-michigan-blue rounded-r-xl p-6 mb-8 shadow-michigan">
        <div class="flex items-start">
            <div class="w-12 h-12 bg-michigan-gradient rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                <i class="fas fa-microphone text-white text-lg"></i>
            </div>
            <div>
                <h3 class="text-lg font-bold text-michigan-blue mb-2">Audio Recording Preferred</h3>
                <p class="text-gray-700">We prefer audio recordings for better feedback and analysis. 75 seconds is the maximum recording time. If you don't provide an audio file, we'll use your text input instead. After submission, "Your Answer" will be replaced with your audio transcription.</p>
            </div>
        </div>
    </div>

    <!-- Unified Two-Column Layout for All Questions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- Left Column: Question Information & Context -->
        <div class="lg:sticky lg:top-6 lg:h-fit space-y-6">
            <!-- Enhanced Question Header with Voice Recording -->
            <div class="text-center">
                <div class="inline-flex items-center px-4 py-2 bg-michigan-gradient-light rounded-full text-sm font-semibold text-michigan-blue mb-6 shadow-michigan">
                    <i class="fas fa-question-circle mr-2 text-michigan-maize"></i>
                    {% if question.case_context %}Case Study Question{% else %}Interview Question{% endif %}
                </div>
                
                <h1 class="text-3xl lg:text-4xl font-black text-michigan-blue mb-6 leading-tight">{{ question.title }}</h1>
                
                <div class="flex flex-wrap items-center justify-center gap-3 mb-6">
                    <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-gradient-to-r from-blue-100 to-blue-200 text-blue-800 shadow-sm">
                        <i class="fas fa-chart-bar mr-2"></i>
                        {{ question.get_difficulty_display }}
                    </span>
                    <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-gradient-to-r from-michigan-maize to-yellow-300 text-michigan-blue shadow-sm">
                        <i class="fas fa-tag mr-2"></i>
                        {{ question.get_question_type_display }}
                    </span>
                    <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 shadow-sm">
                        <i class="fas fa-users mr-2"></i>
                        {{ club.name }}
                    </span>
                </div>
                
                <div class="card-michigan p-6 shadow-michigan">
                    <p class="text-xl text-gray-700 leading-relaxed">{{ question.question_text }}</p>
                </div>
            </div>



        {% if question.case_context %}
                <!-- Case Context Section -->
                <div class="card-michigan p-6 shadow-michigan">
                    <div class="flex items-center justify-center mb-6">
                        <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-file-alt text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold text-purple-700">Case Context</h3>
                    </div>
                    
                    <div class="prose prose-sm max-w-none">
                        <div class="bg-purple-50 p-4 rounded-xl border-l-4 border-purple-400">
                            <p class="text-gray-700 leading-relaxed text-sm">{{ question.case_context|linebreaks }}</p>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        <p class="text-xs text-blue-700 text-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            Reference this context while answering
                        </p>
                    </div>
                </div>
            {% endif %}

        <!-- Enhanced Progress Status -->
            <div class="text-center">
            {% if question_progress.completed %}
                <div class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-green-100 to-green-200 text-green-800 rounded-full font-semibold shadow-sm">
                    <i class="fas fa-check-circle mr-2"></i>Completed
                </div>
            {% elif question_progress.attempted %}
                <div class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-800 rounded-full font-semibold shadow-sm">
                    <i class="fas fa-clock mr-2"></i>Attempted
                </div>
            {% else %}
                <div class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 text-gray-800 rounded-full font-semibold shadow-sm">
                    <i class="fas fa-play mr-2"></i>Not Started
                </div>
            {% endif %}
        </div>

            <!-- Enhanced AI Feedback - Moved to Left Column -->
        {% if question_progress.feedback %}
                <div class="card-michigan p-6 shadow-michigan border-l-4 border-green-400 mt-6">
                    <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-green-400 to-green-500 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-robot text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-green-700">AI Feedback</h3>
                </div>
                <div class="bg-green-50 p-4 rounded-xl">
                    <p class="text-gray-800 leading-relaxed font-medium">{{ question_progress.feedback }}</p>
                </div>
            </div>
        {% endif %}
            </div>
            
        <!-- Right Column: Interactive Elements -->
        <div class="space-y-8">

        <!-- Enhanced Voice Recording Section -->
            <div class="card-michigan p-6 shadow-michigan">
                <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-michigan-gradient rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-microphone text-white text-lg"></i>
                    </div>
                    <h3 class="text-xl font-bold text-michigan-blue">Voice Recording</h3>
            </div>
            
            <!-- Recording Controls -->
                <div class="flex flex-wrap items-center gap-4 mb-6">
                <button id="startRecording" class="btn-michigan inline-flex items-center">
                    <i class="fas fa-record-vinyl mr-2"></i>
                    Start Recording
                </button>
                <button id="stopRecording" class="bg-red-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-red-600 transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-1 hidden inline-flex items-center">
                    <i class="fas fa-stop mr-2"></i>
                    Stop Recording
                </button>
                <div class="flex items-center space-x-3">
                    <span id="recordingStatus" class="text-sm text-gray-600"></span>
                    <span id="recordingTimer" class="text-lg font-mono text-michigan-blue font-bold"></span>
                </div>
            </div>

            <!-- Audio Playback -->
            <div id="audioPlayback" class="hidden mb-6">
                <div class="bg-michigan-gradient-light p-4 rounded-xl">
                    <audio id="recordedAudio" controls class="w-full mb-4">
                        Your browser does not support the audio element.
                    </audio>
                    <div class="flex justify-center space-x-3">
                        <button id="downloadAudio" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-600 transition-colors inline-flex items-center">
                            <i class="fas fa-download mr-2"></i>Download Audio
                        </button>
                        <button id="useRecording" class="btn-michigan text-sm px-4 py-2 inline-flex items-center">
                            <i class="fas fa-check mr-2"></i>Use This Recording
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recording Status -->
            <div id="recordingIndicator" class="hidden flex items-center justify-center space-x-3 text-red-600 bg-red-50 p-4 rounded-xl">
                <div class="w-4 h-4 bg-red-500 rounded-full animate-pulse"></div>
                <span class="font-semibold">Recording in progress...</span>
            </div>
        </div>

        <!-- Enhanced Practice Form -->
            <form method="post" enctype="multipart/form-data" class="card-michigan p-6 shadow-michigan">
            {% csrf_token %}
            
                <div class="flex items-center mb-6">
                <div class="w-12 h-12 bg-michigan-gradient rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-edit text-white text-lg"></i>
                    </div>
                    <h3 class="text-xl font-bold text-michigan-blue">Your Response</h3>
            </div>

                <div class="space-y-6">
                <!-- Answer Textarea -->
                    <div>
                        <label for="user_answer" class="flex items-center text-lg font-bold text-michigan-blue mb-4">
                        <i class="fas fa-comment mr-3"></i>Text Response (Will use text if no audio is provided)
                    </label>
                    <textarea name="user_answer" id="user_answer" rows="8" 
                        class="form-input w-full bg-white/80 text-gray-800 placeholder-gray-500" 
                        placeholder="Type your answer here... Be specific and authentic in your response.">{{ question_progress.user_answer }}</textarea>
                        <p class="text-sm text-gray-500 mt-3">
                        <i class="fas fa-lightbulb mr-1"></i>
                        Tip: Include specific examples and be genuine in your response.
                    </p>
                </div>
                
                <!-- Notes Textarea -->
                    <div>
                        <label for="notes" class="flex items-center text-lg font-bold text-michigan-blue mb-4">
                        <i class="fas fa-sticky-note mr-3"></i>Your Notes (optional)
                    </label>
                    <textarea name="notes" id="notes" rows="3" 
                        class="form-input w-full bg-white/80 text-gray-800 placeholder-gray-500" 
                        placeholder="Add any notes, thoughts, or areas you want to improve...">{{ question_progress.notes }}</textarea>
                </div>
                
                <!-- Audio File Upload -->
                    <div>
                        <label for="response_audio" class="flex items-center text-lg font-bold text-michigan-blue mb-4">
                        <i class="fas fa-microphone mr-3"></i>Audio Response (Preferred)
                    </label>
                    <div class="relative">
                        <input type="file" name="response_audio" id="response_audio" accept="audio/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <div id="file-upload-area" class="flex items-center justify-center w-full p-6 border-2 border-dashed border-michigan-blue/30 rounded-xl bg-michigan-gradient-light hover:bg-michigan-gradient-light/80 transition-all duration-300 cursor-pointer">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-michigan-gradient rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-cloud-upload-alt text-white text-2xl"></i>
                                </div>
                                <span id="file-upload-text" class="text-lg font-semibold text-michigan-blue">Choose audio file or drag and drop</span>
                                <p class="text-sm text-gray-600 mt-2">Supports all audio formats • Max 75 seconds</p>
                            </div>
                        </div>
                    </div>
                    <div id="file-info" class="hidden mt-3 p-4 bg-green-50 border border-green-200 rounded-xl">
                        <div class="flex items-center justify-center space-x-3">
                            <i class="fas fa-check-circle text-green-600"></i>
                            <span id="file-name" class="font-semibold text-green-800"></span>
                        </div>
                    </div>
                        <p class="text-sm text-gray-500 mt-3">
                        <i class="fas fa-info-circle mr-1"></i>
                        Record your answer above, then use "Use This Recording" to add it to your submission.
                    </p>
                </div>
            </div>
            
            <!-- Submit Section -->
                <div class="flex flex-col items-center gap-4 mt-8 pt-6 border-t border-gray-200">
                <button type="submit" class="btn-michigan text-lg px-8 py-3 inline-flex items-center">
                    <i class="fas fa-paper-plane mr-3"></i>
                    {% if question_progress.completed %}Update Answer{% else %}Submit Answer{% endif %}
                </button>
                {% if question.sample_answer %}
                    <button type="button" onclick="document.getElementById('sample-answer').classList.toggle('hidden')" 
                        class="bg-gray-200 text-gray-800 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-colors inline-flex items-center">
                        <i class="fas fa-eye mr-2"></i>Show Sample Answer
                    </button>
                {% endif %}
            </div>
        </form>

        <!-- Enhanced Sample Answer -->
        {% if question.sample_answer %}
                <div id="sample-answer" class="hidden card-michigan p-6 shadow-michigan border-l-4 border-michigan-maize">
                    <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-michigan-maize to-yellow-400 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-star text-michigan-blue"></i>
                    </div>
                    <h3 class="text-xl font-bold text-michigan-blue">Sample Answer</h3>
                </div>
                <p class="text-gray-700 leading-relaxed">{{ question.sample_answer }}</p>
            </div>
        {% endif %}

        <!-- Enhanced Hints -->
        {% if question.hints %}
                <div class="card-michigan p-6 shadow-michigan border-l-4 border-yellow-400">
                    <div class="flex items-center mb-4">
                    <div class="w-10 h-10 bg-gradient-to-r from-yellow-400 to-yellow-500 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-lightbulb text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-yellow-700">Helpful Hint</h3>
                </div>
                <p class="text-gray-700 leading-relaxed">{{ question.hints }}</p>
            </div>
        {% endif %}



        <!-- Navigation -->
            <div class="flex items-center justify-between pt-6">
            <a href="{% url 'clubs:prep' club.id %}" class="inline-flex items-center text-michigan-blue hover:text-michigan-blue/80 font-semibold transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Question Bank
            </a>
            
            <div class="text-sm text-gray-500">
                <i class="fas fa-clock mr-1"></i>
                Average completion time: 3-5 minutes
            </div>
        </div>
    </div>
    </div>
</div>

<!-- Keep existing loading overlay and scripts -->
<div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50">
  <div class="mb-6">
    <svg class="animate-spin h-12 w-12 text-michigan-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
  </div>
  <div id="loading-message" class="text-xl font-bold text-michigan-blue mb-2"></div>
  <p class="text-gray-600 text-center max-w-md">We're analyzing your response and generating personalized feedback...</p>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let recordingStartTime;
let recordingTimer;
let maxRecordingTime = 75; // seconds
let recordingTimeout = null;

// Check if browser supports MediaRecorder
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    document.getElementById('startRecording').disabled = true;
    document.getElementById('startRecording').textContent = 'Recording not supported';
    document.getElementById('startRecording').classList.add('bg-gray-400');
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = document.getElementById('recordedAudio');
            audio.src = audioUrl;
            
            document.getElementById('audioPlayback').classList.remove('hidden');
            document.getElementById('recordingIndicator').classList.add('hidden');
            document.getElementById('recordingStatus').textContent = `Recording completed! Format: ${mediaRecorder.mimeType}`;
            
            // Store the blob for later use
            window.recordedAudioBlob = audioBlob;
            
            // Change button text to "Re-record"
            const startButton = document.getElementById('startRecording');
            startButton.innerHTML = `
                <i class="fas fa-record-vinyl mr-2"></i>
                Re-record
            `;
            
            // Stop all tracks
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        startTimer();

        // Cap recording at 75 seconds
        recordingTimeout = setTimeout(() => {
            stopRecording();
        }, maxRecordingTime * 1000);

        document.getElementById('startRecording').classList.add('hidden');
        document.getElementById('stopRecording').classList.remove('hidden');
        document.getElementById('recordingIndicator').classList.remove('hidden');
        document.getElementById('recordingStatus').textContent = 'Recording...';
        
    } catch (error) {
        console.error('Error accessing microphone:', error);
        alert('Unable to access microphone. Please check your browser permissions.');
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(recordingTimer);
        if (recordingTimeout) {
            clearTimeout(recordingTimeout);
            recordingTimeout = null;
        }
        document.getElementById('startRecording').classList.remove('hidden');
        document.getElementById('stopRecording').classList.add('hidden');
    }
}

function startTimer() {
    recordingTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('recordingTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function downloadAudio() {
    if (window.recordedAudioBlob) {
        const url = URL.createObjectURL(window.recordedAudioBlob);
        const a = document.createElement('a');
        a.href = url;
        
        // Get the correct file extension based on MIME type
        let extension = 'webm'; // default
        if (window.recordedAudioBlob.type.includes('mp4')) {
            extension = 'm4a';
        } else if (window.recordedAudioBlob.type.includes('ogg')) {
            extension = 'ogg';
        } else if (window.recordedAudioBlob.type.includes('webm')) {
            extension = 'webm';
        }
        
        a.download = `interview_response_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.${extension}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
}

function useRecording() {
    if (window.recordedAudioBlob) {
        // Get the correct file extension based on MIME type
        let extension = 'webm'; // default
        if (window.recordedAudioBlob.type.includes('mp4')) {
            extension = 'm4a';
        } else if (window.recordedAudioBlob.type.includes('ogg')) {
            extension = 'ogg';
        } else if (window.recordedAudioBlob.type.includes('webm')) {
            extension = 'webm';
        }
        
        // Create a File object from the blob
        const file = new File([window.recordedAudioBlob], `recorded_response.${extension}`, { type: window.recordedAudioBlob.type });
        
        // Create a new FileList-like object
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        
        // Set the file input
        const fileInput = document.getElementById('response_audio');
        fileInput.files = dataTransfer.files;
        
        // Manually trigger the change event to update the UI
        const changeEvent = new Event('change', { bubbles: true });
        fileInput.dispatchEvent(changeEvent);
        
        alert('Recording added to form! You can now submit your answer.');
    }
}

// File input handling
document.getElementById('response_audio').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileUploadText = document.getElementById('file-upload-text');
    const fileUploadArea = document.getElementById('file-upload-area');
    
    if (file) {
        // Show file info
        fileName.textContent = file.name;
        fileInfo.classList.remove('hidden');
        
        // Update upload area appearance
        fileUploadArea.classList.remove('border-michigan-blue/30', 'bg-michigan-gradient-light');
        fileUploadArea.classList.add('border-green-300', 'bg-green-50');
        fileUploadText.textContent = 'File selected ✓';
    } else {
        // Hide file info
        fileInfo.classList.add('hidden');
        
        // Reset upload area appearance
        fileUploadArea.classList.remove('border-green-300', 'bg-green-50');
        fileUploadArea.classList.add('border-michigan-blue/30', 'bg-michigan-gradient-light');
        fileUploadText.textContent = 'Choose audio file or drag and drop';
    }
});

// Event listeners
document.getElementById('startRecording').addEventListener('click', startRecording);
document.getElementById('stopRecording').addEventListener('click', stopRecording);
document.getElementById('downloadAudio').addEventListener('click', downloadAudio);
document.getElementById('useRecording').addEventListener('click', useRecording);

let loadingMessages = [
  'Sending your answer...',
  'Digging for patterns...',
  'Genearating insights...',
  'Sharpening feedback...'
];
let loadingMessageIndex = 0;
let loadingMessageInterval;

function startLoadingMessages() {
  loadingMessageIndex = 0;
  document.getElementById('loading-message').textContent = loadingMessages[loadingMessageIndex];
  loadingMessageInterval = setInterval(() => {
    loadingMessageIndex = (loadingMessageIndex + 1) % loadingMessages.length;
    document.getElementById('loading-message').textContent = loadingMessages[loadingMessageIndex];
  }, 1800);
}

function stopLoadingMessages() {
  clearInterval(loadingMessageInterval);
  document.getElementById('loading-message').textContent = 'Processing your answer...';
}

document.querySelector('form').addEventListener('submit', function() {
  document.getElementById('loading-overlay').classList.remove('hidden');
  startLoadingMessages();
});
</script>
{% endblock %} 